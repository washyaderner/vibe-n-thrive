---
// Mock reviews â€” will be replaced with Google Places API data
const reviews = [
  {
    author: 'Anonymous',
    rating: 5,
    text: 'Part therapy, part sound healing, part meditation. I highly recommend Vibe\'N Thrive Vibro Acoustic Therapy.',
    date: '',
  },
  {
    author: 'Russ',
    rating: 5,
    text: 'I signed up for the 4-session package (The Reset) and was immediately happy about that choice after my first session. The hour went by so quickly and was extremely effective. I suffer from back pain and need chiro regularly. I chose the chakra alignment for my first session and felt amazing afterwards. Carson explained the science behind what was happening and explored some other ideas of what we can do in future sessions.\n\nMy wife and I both did a session the same day, about two months post-foot-surgery for her, so at that time, the foot pain was slowly leaving while back pain was coming in strong due to a shift in which side of her body was holding most of her weight. She ended up doing a muscle/tissue focused healing session, and it worked wonders. She was having trouble sleeping prior to our visit, for a few nights in a row, but after her session, she slept like a baby that night. I can\'t thank Carson enough for guiding us through the sessions and curating them so perfectly for us.\n\nHighly recommend setting up multiple sessions and going regularly. The benefits compound.',
    date: '',
  },
  {
    author: 'William',
    rating: 5,
    text: 'I was unaware of how effective and healing this could be. Carson facilitated my first experience with this type of therapy and I definitely felt a shift in my energy and consciousness, on a spiritual level. It was beyond what I had thought was even possible. 10/10 thanks Carson!',
    date: '',
  },
];

function stars(rating: number) {
  return Array.from({ length: 5 }, (_, i) => i < rating ? 'filled' : 'empty');
}
---

<section class="reviews section" id="reviews">
  <div class="container">
    <div class="text-center">
      <p class="section-label">Reviews</p>
      <h2 class="section-title">What Our Clients Say</h2>
      <p class="section-subtitle" style="margin-left:auto;margin-right:auto;">
        Real experiences from real people finding relief through vibration therapy.
      </p>
    </div>

    <div class="reviews__track-wrapper">
    <div class="reviews__track" id="reviews-track">
      {reviews.map(review => (
        <div class="reviews__card liquid-glass">
          <div class="reviews__stars">
            {stars(review.rating).map(state => (
              <span class={`reviews__star reviews__star--${state}`}>&#9733;</span>
            ))}
          </div>
          <p class="reviews__text">{review.text}</p>
          <div class="reviews__meta">
            <span class="reviews__author">{review.author}</span>
            <span class="reviews__date">{review.date}</span>
          </div>
        </div>
      ))}
    </div>
    </div>

    <div class="reviews__nav">
      <button class="reviews__btn" id="prev-review" aria-label="Previous review">&#8592;</button>
      <div class="reviews__dots" id="review-dots"></div>
      <button class="reviews__btn" id="next-review" aria-label="Next review">&#8594;</button>
    </div>
  </div>
</section>

<style>
  .reviews__track-wrapper {
    position: relative;
    -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
    mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
  }

  .reviews__track {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    padding: 1rem 0 2rem;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .reviews__track::-webkit-scrollbar {
    display: none;
  }

  .reviews__card {
    min-width: min(360px, 85vw);
    max-width: 400px;
    flex-shrink: 0;
    scroll-snap-align: start;
    padding: 2rem;
    box-shadow:
      0 0 20px rgba(13, 148, 136, 0.12),
      0 0 60px rgba(13, 148, 136, 0.06),
      0 4px 30px rgba(0, 0, 0, 0.04);
  }

  .reviews__stars {
    display: flex;
    gap: 2px;
    margin-bottom: 1rem;
  }

  .reviews__star {
    font-size: 1.125rem;
  }

  .reviews__star--filled {
    color: #f59e0b;
  }

  .reviews__star--empty {
    color: var(--color-gray-200);
  }

  .reviews__text {
    font-size: 0.9375rem;
    color: var(--color-gray-600);
    line-height: 1.7;
    margin-bottom: 1.5rem;
    white-space: pre-line;
  }

  .reviews__meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .reviews__author {
    font-weight: 600;
    color: var(--color-gray-800);
    font-size: 0.9375rem;
  }

  .reviews__date {
    font-size: 0.8125rem;
    color: var(--color-gray-400);
  }

  .reviews__nav {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    margin-top: 1rem;
  }

  .reviews__btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1px solid var(--color-gray-200);
    background: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    font-size: 1.125rem;
    color: var(--color-gray-600);
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .reviews__btn:hover {
    background: var(--color-teal);
    color: white;
    border-color: var(--color-teal);
  }

  .reviews__dots {
    display: flex;
    gap: 8px;
  }

  :global(.reviews__dot) {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-gray-200);
    border: none;
    cursor: pointer;
    transition: all var(--transition-base);
    padding: 0;
  }

  :global(.reviews__dot.active) {
    background: var(--color-teal);
    width: 24px;
    border-radius: 100px;
  }
</style>

<script>
  const track = document.getElementById('reviews-track');
  const prevBtn = document.getElementById('prev-review');
  const nextBtn = document.getElementById('next-review');
  const dotsContainer = document.getElementById('review-dots');

  if (track && dotsContainer) {
    const cards = track.querySelectorAll('.reviews__card');
    let currentIndex = 0;

    // Create dots
    cards.forEach((_, i) => {
      const dot = document.createElement('button');
      dot.className = `reviews__dot${i === 0 ? ' active' : ''}`;
      dot.setAttribute('aria-label', `Go to review ${i + 1}`);
      dot.addEventListener('click', () => scrollToCard(i));
      dotsContainer.appendChild(dot);
    });

    function scrollToCard(index: number) {
      const card = cards[index] as HTMLElement;
      if (!card) return;
      track!.scrollTo({ left: card.offsetLeft - 16, behavior: 'smooth' });
      currentIndex = index;
      updateDots();
    }

    function updateDots() {
      dotsContainer!.querySelectorAll('.reviews__dot').forEach((dot, i) => {
        dot.classList.toggle('active', i === currentIndex);
      });
    }

    prevBtn?.addEventListener('click', () => {
      currentIndex = Math.max(0, currentIndex - 1);
      scrollToCard(currentIndex);
    });

    nextBtn?.addEventListener('click', () => {
      currentIndex = Math.min(cards.length - 1, currentIndex + 1);
      scrollToCard(currentIndex);
    });

    // Update dots on scroll
    let scrollTimeout: ReturnType<typeof setTimeout>;
    track.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const scrollLeft = track!.scrollLeft;
        let closestIndex = 0;
        let closestDist = Infinity;
        cards.forEach((card, i) => {
          const dist = Math.abs((card as HTMLElement).offsetLeft - scrollLeft - 16);
          if (dist < closestDist) {
            closestDist = dist;
            closestIndex = i;
          }
        });
        currentIndex = closestIndex;
        updateDots();
      }, 50);
    }, { passive: true });
  }
</script>
